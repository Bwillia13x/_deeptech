name: Tests

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]

jobs:
    test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.12"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev]"

            - name: Initialize database
              run: |
                  python -m signal_harvester.cli.main init-db
              env:
                  DATABASE_PATH: var/test.db

            - name: Run migrations
              run: |
                  alembic upgrade head
              env:
                  DATABASE_PATH: var/test.db

            - name: Run tests with coverage
              run: |
                  pytest tests/ \
                    --cov=src/signal_harvester \
                    --cov-report=term-missing \
                    --cov-report=xml \
                    --cov-report=html \
                    -v \
                    --tb=short
              env:
                  DATABASE_PATH: var/test.db
                  PYTEST_DISABLE_PLUGIN_AUTOLOAD: 1

            - name: Upload coverage reports
              uses: codecov/codecov-action@v4
              if: matrix.python-version == '3.12'
              with:
                  file: ./coverage.xml
                  flags: unittests
                  name: codecov-umbrella
                  fail_ci_if_error: false
              env:
                  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

            - name: Archive coverage HTML report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-report
                  path: htmlcov/
                  retention-days: 30

            - name: Check coverage threshold
              run: |
                  coverage report --fail-under=70
              continue-on-error: true

    test-integration:
        runs-on: ubuntu-latest
        needs: test

        services:
            redis:
                image: redis:7-alpine
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
                ports:
                    - 6379:6379

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e ".[dev]"

            - name: Initialize database
              run: |
                  python -m signal_harvester.cli.main init-db

            - name: Run integration tests
              run: |
                  pytest tests/test_integration.py tests/test_api.py -v
              env:
                  REDIS_HOST: localhost
                  REDIS_PORT: 6379
                  DATABASE_PATH: var/test_integration.db
